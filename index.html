import os
from PIL import Image

def optimize_images(folder_path='.', max_width=1000, quality=85):
    """
    Resizes and compresses images in the folder to high-quality JPGs.
    """
    # Create output folder
    output_folder = os.path.join(folder_path, 'optimized')
    if not os.path.exists(output_folder):
        os.makedirs(output_folder)

    # supported extensions
    extensions = ('.jpg', '.jpeg', '.png', '.webp')

    print(f"Processing images in: {os.path.abspath(folder_path)}")
    print("-" * 30)

    for filename in os.listdir(folder_path):
        if filename.lower().endswith(extensions) and filename != "optimize_images.py":
            file_path = os.path.join(folder_path, filename)
            
            try:
                with Image.open(file_path) as img:
                    # Convert to RGB (removes transparency if PNG)
                    if img.mode in ("RGBA", "P"):
                        img = img.convert("RGB")

                    # Calculate new height to maintain aspect ratio
                    width_percent = (max_width / float(img.size[0]))
                    
                    # Only resize if the image is larger than max_width
                    if width_percent < 1:
                        new_height = int((float(img.size[1]) * float(width_percent)))
                        img = img.resize((max_width, new_height), Image.Resampling.LANCZOS)
                        print(f"Resized: {filename}")
                    else:
                        print(f"Original size kept: {filename}")

                    # Save as JPG to the 'optimized' folder
                    # We force the extension to .jpg to match your HTML code
                    new_filename = os.path.splitext(filename)[0] + ".jpg"
                    output_path = os.path.join(output_folder, new_filename)
                    
                    img.save(output_path, "JPEG", quality=quality, optimize=True)
                    print(f"Saved: {new_filename} (Quality: {quality})")

            except Exception as e:
                print(f"Error processing {filename}: {e}")

    print("-" * 30)
    print("Done! Copy the images from the 'optimized' folder to your main folder.")

if __name__ == "__main__":
    optimize_images()